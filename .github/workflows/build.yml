name: osc-sdk-java release build
on:
  workflow_dispatch:
    inputs:
      api_version:
        description: 'Outscale API version'
        required: true

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  auto-build:
    environment: auto-build
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: chainguard-dev/actions/setup-gitsign@main
      - uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5
        with:
          distribution: 'temurin' 
          java-version: '11'
          cache: 'maven'

      - name: Write Outscale API version to use
        run: echo "${{ github.event.inputs.api_version }}" > api_version
      - name: auto-generate release
        run: make release-build

      - name: Get SDK version
        id: get-sdk-version
        run: |
          echo "sdk_version=$(cat ./sdk_version)" >> "$GITHUB_OUTPUT"
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          committer: "Outscale Bot <opensource+bot@outscale.com>"
          author: "Outscale Bot <opensource+bot@outscale.com>"
          commit-message: "ðŸ”– release: osc-sdk-java v${{ env.sdk_version }}"
          body: |
            Automatic build of SDK v${{ env.sdk_version }} version based on Outscale API ${{ env.api_version }}.
          title: "SDK v${{ env.sdk_version }}"
          token: "${{ env.token }}"
        env:
          sdk_version: ${{ steps.get-sdk-version.outputs.sdk_version }}
          api_version: ${{ github.event.inputs.api_version }}
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
